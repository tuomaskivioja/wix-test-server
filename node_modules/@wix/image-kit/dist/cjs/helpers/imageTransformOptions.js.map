{"version":3,"names":["_utils","require","_imageServiceUtils","_imageServiceConstants","setTransformOptions","transformsObj","options","_options","quality","getQuality","progressive","getProgressive","watermark","getWatermark","autoEncode","encoding","unsharpMask","getUnsharpMask","filters","getFilters","isPNG","fileType","PNG","isJPG","JPG","isWEBP","WEBP","isQualitySupported","transformData","last","parts","defaultQuality","getPreferredImageQuality","width","height","filterOptions","isValidImageFilter","imageFilters","CONTRAST","BRIGHTNESS","SATURATION","HUE","BLUR","filterValue","minValue","maxValue","isNaN","isUSMValid","_options$unsharpMask","_options$unsharpMask2","_options$unsharpMask3","radius","roundToFixed","amount","threshold","isZeroUSM","isUSMNeeded","defaultUSM","transformPart","upscale","scaleFactor","forceUSM","transformType","transformTypes","FIT","usm"],"sources":["../../../src/helpers/imageTransformOptions.ts"],"sourcesContent":["import { last } from './utils';\nimport { getPreferredImageQuality, roundToFixed } from './imageServiceUtils';\nimport {\n  defaultUSM,\n  fileType,\n  imageFilters,\n  transformTypes,\n} from './imageServiceConstants';\nimport type {\n  ImageTransformFiltersOption,\n  ImageTransformObject,\n  ImageTransformOptions,\n  OptionUnsharpMask,\n  TemplateUnsharpMask,\n} from '../types';\n\n/**\n * returns image filters part of the image transform uri\n * @param {ImageTransformObject}    transformsObj    transform parts object\n * @param {ImageTransformOptions}   [options]\n */\nfunction setTransformOptions(\n  transformsObj: ImageTransformObject,\n  options?: ImageTransformOptions,\n) {\n  options = options || {};\n  // options - general\n  transformsObj.quality = getQuality(transformsObj, options);\n  transformsObj.progressive = getProgressive(options);\n  transformsObj.watermark = getWatermark(options);\n  transformsObj.autoEncode = options.autoEncode ?? true;\n  transformsObj.encoding = options?.encoding;\n  // options - filters & adjustments\n  transformsObj.unsharpMask = getUnsharpMask(transformsObj, options);\n  transformsObj.filters = getFilters(options);\n}\n\n/**\n *\n * @param {ImageTransformOptions}   options\n * @returns {string}\n */\nfunction getWatermark(options: ImageTransformOptions) {\n  return options.watermark;\n}\n\n/**\n * returns progressive if required\n * @param {ImageTransformOptions}   options\n *\n * @returns {boolean}\n */\nfunction getProgressive(options: ImageTransformOptions) {\n  return options.progressive !== false;\n}\n\n/**\n * returns image filters part of the image transform uri\n * @param {ImageTransformObject}    transformsObj    transform parts object\n * @param {ImageTransformOptions}   options\n *\n * @returns {number}\n */\nfunction getQuality(\n  transformsObj: ImageTransformObject,\n  options: ImageTransformOptions,\n) {\n  const isPNG = transformsObj.fileType === fileType.PNG;\n  const isJPG = transformsObj.fileType === fileType.JPG;\n  const isWEBP = transformsObj.fileType === fileType.WEBP;\n\n  const isQualitySupported = isJPG || isPNG || isWEBP;\n  if (isQualitySupported) {\n    const transformData = last(transformsObj.parts);\n\n    const defaultQuality = getPreferredImageQuality(\n      transformData.width,\n      transformData.height,\n    );\n    let quality =\n      options.quality && options.quality >= 5 && options.quality <= 90\n        ? options.quality\n        : defaultQuality;\n    // increase quality by 5 for webp images\n    quality = isPNG ? quality + 5 : quality;\n    return quality;\n  }\n  // quality not supported\n  return 0;\n}\n\n/**\n * returns the desired transformed image filters\n * @param {ImageTransformOptions}   options\n *\n * @returns {object}\n */\nfunction getFilters(options: ImageTransformOptions) {\n  const filterOptions: ImageTransformFiltersOption = options.filters || {};\n  const filters: ImageTransformFiltersOption = {};\n\n  // contrast\n  if (isValidImageFilter(filterOptions[imageFilters.CONTRAST], -100, 100)) {\n    filters[imageFilters.CONTRAST] = filterOptions[imageFilters.CONTRAST];\n  }\n\n  // brightness\n  if (isValidImageFilter(filterOptions[imageFilters.BRIGHTNESS], -100, 100)) {\n    filters[imageFilters.BRIGHTNESS] = filterOptions[imageFilters.BRIGHTNESS];\n  }\n\n  // saturation\n  if (isValidImageFilter(filterOptions[imageFilters.SATURATION], -100, 100)) {\n    filters[imageFilters.SATURATION] = filterOptions[imageFilters.SATURATION];\n  }\n\n  // hue\n  if (isValidImageFilter(filterOptions[imageFilters.HUE], -180, 180)) {\n    filters[imageFilters.HUE] = filterOptions[imageFilters.HUE];\n  }\n\n  // blur\n  if (isValidImageFilter(filterOptions[imageFilters.BLUR], 0, 100)) {\n    filters[imageFilters.BLUR] = filterOptions[imageFilters.BLUR];\n  }\n\n  return filters;\n}\n\n/**\n * indicates if requested filter value is valid\n * @param {number|undefined}  filterValue     filter's value\n * @param {number}  minValue        min range\n * @param {number}  maxValue        max range\n *\n * @returns {boolean}\n */\nfunction isValidImageFilter(\n  filterValue: number | undefined,\n  minValue: number,\n  maxValue: number,\n) {\n  // check if filter name and filter values range valid\n  return (\n    typeof filterValue === 'number' &&\n    !isNaN(filterValue) &&\n    filterValue !== 0 &&\n    filterValue >= minValue &&\n    filterValue <= maxValue\n  );\n}\n\n/**\n * returns the desired transformed image unSharpMask values\n * @param {ImageTransformObject}    transformsObj    transform parts object\n * @param {ImageTransformOptions}   options\n *\n * @returns {object}\n */\nfunction getUnsharpMask(\n  transformsObj: ImageTransformObject,\n  options: ImageTransformOptions,\n): TemplateUnsharpMask | undefined {\n  // If options.unsharpMask is a valid value, use it\n  if (isUSMValid(options.unsharpMask)) {\n    // If we got usm, change values to have trailing zeros (.00), else return undefined\n    return {\n      radius: roundToFixed(options.unsharpMask?.radius!, 2),\n      amount: roundToFixed(options.unsharpMask?.amount!, 2),\n      threshold: roundToFixed(options.unsharpMask?.threshold!, 2),\n    };\n    // if options.unsharpMask is not all zeros and not valid and usm should be used, use default\n  } else if (!isZeroUSM(options.unsharpMask) && isUSMNeeded(transformsObj)) {\n    return defaultUSM;\n  }\n\n  return;\n}\n\n/**\n * indicates if usm is needed\n * @param {ImageTransformObject}      transformsObj   transform parts object\n *\n * @returns {boolean}\n */\nfunction isUSMNeeded(transformsObj: ImageTransformObject) {\n  // ---------------------------------------------------------------------------------------\n  // do not apply usm if transformed image width & height is same as source image or larger\n  // and no force usm is desired\n  // and transform type is not fit\n  // ---------------------------------------------------------------------------------------\n  const transformPart = last(transformsObj.parts);\n  const upscale = transformPart.scaleFactor >= 1;\n\n  // return if usm is needed\n  return (\n    !upscale ||\n    transformPart.forceUSM ||\n    transformPart.transformType === transformTypes.FIT\n  );\n}\n\n/**\n * indicates if all usm values are presented and in range\n * @param {OptionUnsharpMask|undefined}  usm     unsharp mask\n *\n * @returns {boolean}\n */\nfunction isUSMValid(usm: OptionUnsharpMask | undefined) {\n  usm = usm || ({} as OptionUnsharpMask);\n  const radius =\n    typeof usm.radius === 'number' &&\n    !isNaN(usm.radius) &&\n    usm.radius >= 0.1 &&\n    usm.radius <= 500;\n  const amount =\n    typeof usm.amount === 'number' &&\n    !isNaN(usm.amount) &&\n    usm.amount >= 0 &&\n    usm.amount <= 10;\n  const threshold =\n    typeof usm.threshold === 'number' &&\n    !isNaN(usm.threshold) &&\n    usm.threshold >= 0 &&\n    usm.threshold <= 255;\n\n  // return is a valid USM data\n  return radius && amount && threshold;\n}\n\n/**\n * indicates if all usm values are presented and are zero. an explicit request to not apply usm\n * @param {OptionUnsharpMask|undefined}  usm     unsharp mask\n *\n * @returns {boolean}\n */\nfunction isZeroUSM(usm: OptionUnsharpMask | undefined) {\n  usm = usm || ({} as OptionUnsharpMask);\n  return (\n    typeof usm.radius === 'number' &&\n    !isNaN(usm.radius) &&\n    usm.radius === 0 &&\n    typeof usm.amount === 'number' &&\n    !isNaN(usm.amount) &&\n    usm.amount === 0 &&\n    typeof usm.threshold === 'number' &&\n    !isNaN(usm.threshold) &&\n    usm.threshold === 0\n  );\n}\n\nexport { setTransformOptions };\n"],"mappings":"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","ignoreList":[]}