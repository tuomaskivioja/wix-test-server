{"version":3,"names":["_querystring","_interopRequireDefault","require","_toAltText","WIX_IMAGE_PROTOCOL","WIX_LEGACY_IMAGE_PROTOCOL","WIX_IMAGE_PROTOCOL_SUFFIX","URL_HASH_PREFIX","DEFAULT_IMAGE_FILE_NAME","alignIfLegacyImage","image","protocol","URL","corvidToP13n","undefined","alignedImage","hash","pathname","originHeight","height","originWidth","width","querystring","parse","replace","id","filename","split","Number","altText","toAltText","url","exports","computeImageFileName","encodeURIComponent","p13nToCorvid"],"sources":["../../../src/image/index.ts"],"sourcesContent":["import querystring from 'querystring';\nimport { responses } from '../proto-generated/server';\nimport { toAltText } from './toAltText';\n\ntype IImage = responses.wix.common.IImage;\n\nconst WIX_IMAGE_PROTOCOL = 'wix:';\nconst WIX_LEGACY_IMAGE_PROTOCOL = 'image:';\nconst WIX_IMAGE_PROTOCOL_SUFFIX = 'image://v1/';\nconst URL_HASH_PREFIX = '#';\n\nconst DEFAULT_IMAGE_FILE_NAME = 'file';\n\nconst alignIfLegacyImage = (image: string): string => {\n  const { protocol } = new URL(image);\n\n  return protocol === WIX_LEGACY_IMAGE_PROTOCOL ? `wix:${image}` : image;\n};\n\nconst corvidToP13n = (image?: string | null): undefined | IImage => {\n  if (!image) {\n    return undefined;\n  }\n\n  const alignedImage = alignIfLegacyImage(image);\n\n  const { protocol, hash, pathname } = new URL(alignedImage);\n  const { originHeight: height, originWidth: width } = querystring.parse(\n    hash.replace(URL_HASH_PREFIX, ''),\n  );\n  const [id, filename] = pathname\n    .replace(WIX_IMAGE_PROTOCOL_SUFFIX, '')\n    .split('/');\n\n  if (protocol === WIX_IMAGE_PROTOCOL) {\n    return {\n      id,\n      height: Number(height),\n      width: Number(width),\n      altText: toAltText(filename),\n    };\n  }\n\n  return { url: image };\n};\n\nconst computeImageFileName = (image: IImage) => {\n  const filename = image.altText ?? DEFAULT_IMAGE_FILE_NAME;\n\n  return encodeURIComponent(filename);\n};\n\nconst p13nToCorvid = (image?: IImage | null): undefined | string => {\n  if (!image) {\n    return undefined;\n  }\n\n  return image.id\n    ? `wix:image://v1/${image.id}/${computeImageFileName(\n        image,\n      )}#originWidth=${image.width!}&originHeight=${image.height!}`\n    : image?.url;\n};\n\nexport { corvidToP13n, p13nToCorvid };\n"],"mappings":";;;;;AAAA,IAAAA,YAAA,GAAAC,sBAAA,CAAAC,OAAA;AAEA,IAAAC,UAAA,GAAAD,OAAA;AAIA,MAAME,kBAAkB,GAAG,MAAM;AACjC,MAAMC,yBAAyB,GAAG,QAAQ;AAC1C,MAAMC,yBAAyB,GAAG,aAAa;AAC/C,MAAMC,eAAe,GAAG,GAAG;AAE3B,MAAMC,uBAAuB,GAAG,MAAM;AAEtC,MAAMC,kBAAkB,GAAIC,KAAa,IAAa;EACpD,MAAM;IAAEC;EAAS,CAAC,GAAG,IAAIC,GAAG,CAACF,KAAK,CAAC;EAEnC,OAAOC,QAAQ,KAAKN,yBAAyB,GAAG,OAAOK,KAAK,EAAE,GAAGA,KAAK;AACxE,CAAC;AAED,MAAMG,YAAY,GAAIH,KAAqB,IAAyB;EAClE,IAAI,CAACA,KAAK,EAAE;IACV,OAAOI,SAAS;EAClB;EAEA,MAAMC,YAAY,GAAGN,kBAAkB,CAACC,KAAK,CAAC;EAE9C,MAAM;IAAEC,QAAQ;IAAEK,IAAI;IAAEC;EAAS,CAAC,GAAG,IAAIL,GAAG,CAACG,YAAY,CAAC;EAC1D,MAAM;IAAEG,YAAY,EAAEC,MAAM;IAAEC,WAAW,EAAEC;EAAM,CAAC,GAAGC,oBAAW,CAACC,KAAK,CACpEP,IAAI,CAACQ,OAAO,CAACjB,eAAe,EAAE,EAAE,CAClC,CAAC;EACD,MAAM,CAACkB,EAAE,EAAEC,QAAQ,CAAC,GAAGT,QAAQ,CAC5BO,OAAO,CAAClB,yBAAyB,EAAE,EAAE,CAAC,CACtCqB,KAAK,CAAC,GAAG,CAAC;EAEb,IAAIhB,QAAQ,KAAKP,kBAAkB,EAAE;IACnC,OAAO;MACLqB,EAAE;MACFN,MAAM,EAAES,MAAM,CAACT,MAAM,CAAC;MACtBE,KAAK,EAAEO,MAAM,CAACP,KAAK,CAAC;MACpBQ,OAAO,EAAE,IAAAC,oBAAS,EAACJ,QAAQ;IAC7B,CAAC;EACH;EAEA,OAAO;IAAEK,GAAG,EAAErB;EAAM,CAAC;AACvB,CAAC;AAACsB,OAAA,CAAAnB,YAAA,GAAAA,YAAA;AAEF,MAAMoB,oBAAoB,GAAIvB,KAAa,IAAK;EAC9C,MAAMgB,QAAQ,GAAGhB,KAAK,CAACmB,OAAO,IAAIrB,uBAAuB;EAEzD,OAAO0B,kBAAkB,CAACR,QAAQ,CAAC;AACrC,CAAC;AAED,MAAMS,YAAY,GAAIzB,KAAqB,IAAyB;EAClE,IAAI,CAACA,KAAK,EAAE;IACV,OAAOI,SAAS;EAClB;EAEA,OAAOJ,KAAK,CAACe,EAAE,GACX,kBAAkBf,KAAK,CAACe,EAAE,IAAIQ,oBAAoB,CAChDvB,KACF,CAAC,gBAAgBA,KAAK,CAACW,KAAK,iBAAkBX,KAAK,CAACS,MAAM,EAAG,GAC7DT,KAAK,oBAALA,KAAK,CAAEqB,GAAG;AAChB,CAAC;AAACC,OAAA,CAAAG,YAAA,GAAAA,YAAA","ignoreList":[]}