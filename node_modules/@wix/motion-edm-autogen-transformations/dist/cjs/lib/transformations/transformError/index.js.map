{"version":3,"names":["_constantCase","require","_httpStatusCodes","_jsYaml","_interopRequireDefault","_lodash","_constants","_violationsWithRenamedFields","get","has","forOwn","isEqual","_","UNKNOWN_STATUS_CODE_TEST","MAX_YAML_LINE_WIDTH","CANCELLED_STATUS_CODE","CANCELLED_STATUS_CODE_STRING","toString","CANCELLED_STATUS_TEXT","toYamlString","object","yaml","dump","lineWidth","replace","ambassadorSafeStatusText","_maybeHttpStatus","getReasonPhrase","error","buildError","message","extraProperties","Error","value","key","undefined","isClientError","code","isValidationError","ambassadorHTTPError","isApplicationError","isStatusOfClientError","httpStatus","buildErrorMetadata","errorType","httpStatusCode","buildValidationError","transformation","argumentNames","details","validationError","fieldViolations","response","transformedFieldViolations","violationsWithRenamedFields","sortBy","map","field","description","join","metadata","ErrorType","User","buildApplicationError","statusText","hasEmptyDetails","applicationError","constantCase","data","combinedMessage","buildSystemError","requestId","System","runtimeError","transformError","exports"],"sources":["../../../../../src/lib/transformations/transformError/index.ts"],"sourcesContent":["import { constantCase } from 'constant-case';\nimport { getReasonPhrase } from 'http-status-codes';\nimport yaml from 'js-yaml';\nimport _ from 'lodash';\n\nimport { ErrorType } from '../../constants';\nimport { violationsWithRenamedFields } from './violationsWithRenamedFields';\n\nconst { get, has, forOwn, isEqual } = _;\n\nconst UNKNOWN_STATUS_CODE_TEST = 'Unknown';\n\nconst MAX_YAML_LINE_WIDTH = 1000;\n\nconst CANCELLED_STATUS_CODE = 499;\nconst CANCELLED_STATUS_CODE_STRING = CANCELLED_STATUS_CODE.toString();\nconst CANCELLED_STATUS_TEXT = 'Client Closed Request';\n\nconst toYamlString = (object: any) =>\n  yaml.dump(object, { lineWidth: MAX_YAML_LINE_WIDTH }).replace(/\\n$/, '');\n\nconst ambassadorSafeStatusText = (_maybeHttpStatus: string | number) => {\n  if (\n    _maybeHttpStatus === CANCELLED_STATUS_CODE ||\n    _maybeHttpStatus === CANCELLED_STATUS_CODE_STRING\n  ) {\n    return CANCELLED_STATUS_TEXT;\n  }\n\n  try {\n    return getReasonPhrase(_maybeHttpStatus);\n  } catch (error) {\n    return UNKNOWN_STATUS_CODE_TEST;\n  }\n};\n\nconst buildError = ({\n  message,\n  extraProperties = {},\n}: {\n  message: string;\n  extraProperties: object;\n}) => {\n  const error = new Error(message);\n\n  forOwn(extraProperties, (value, key) => {\n    if (value !== undefined) {\n      error[key] = value;\n    }\n  });\n\n  return error;\n};\n\nconst isClientError = (code: number): boolean => code >= 400 && code < 500;\n\nconst isValidationError = (ambassadorHTTPError: any) =>\n  has(ambassadorHTTPError, 'response.details.validationError');\n\nconst isApplicationError = (ambassadorHTTPError: any) => {\n  const isStatusOfClientError = isClientError(ambassadorHTTPError?.httpStatus);\n\n  return (\n    has(ambassadorHTTPError, 'response.details.applicationError') ||\n    isStatusOfClientError\n  );\n};\n\nconst buildErrorMetadata = (errorType: ErrorType, httpStatusCode?: number) => {\n  return { errorType, httpStatusCode };\n};\n\nconst buildValidationError = (\n  ambassadorHTTPError,\n  transformation,\n  argumentNames,\n) => {\n  const {\n    details: {\n      validationError: { fieldViolations },\n    },\n  } = ambassadorHTTPError.response;\n\n  const transformedFieldViolations = _(\n    violationsWithRenamedFields({\n      transformation,\n      fieldViolations,\n      argumentNames,\n    }),\n  )\n    .sortBy('field')\n    .value();\n\n  const message = `INVALID_ARGUMENT: ${transformedFieldViolations\n    .map(({ field, description }) => field ? `\"${field}\" ${description}` : `${description}`)\n    .join(', ')}`;\n\n  const details = {\n    validationError: { fieldViolations: transformedFieldViolations },\n  };\n\n  const metadata = buildErrorMetadata(\n    ErrorType.User,\n    ambassadorHTTPError.httpStatus,\n  );\n\n  return buildError({\n    message: toYamlString({ message, details }),\n    extraProperties: { details, metadata },\n  });\n};\n\nconst buildApplicationError = (ambassadorHTTPError: any) => {\n  const statusText = ambassadorSafeStatusText(ambassadorHTTPError.httpStatus);\n  const hasEmptyDetails = isEqual(\n    get(ambassadorHTTPError, 'response.details', {}),\n    {},\n  );\n\n  const metadata = buildErrorMetadata(\n    ErrorType.User,\n    ambassadorHTTPError.httpStatus,\n  );\n\n  if (hasEmptyDetails) {\n    const details = {\n      applicationError: {\n        description: statusText,\n        code: constantCase(statusText),\n        data: {},\n      },\n    };\n\n    return buildError({\n      message: toYamlString({\n        message: get(ambassadorHTTPError, 'response.message', statusText),\n        details,\n      }),\n      extraProperties: { details, metadata },\n    });\n  }\n\n  const message = get(ambassadorHTTPError, 'response.message', statusText);\n  const description = get(\n    ambassadorHTTPError,\n    'response.details.applicationError.description',\n    statusText,\n  );\n  const code = get(\n    ambassadorHTTPError,\n    'response.details.applicationError.code',\n    constantCase(statusText),\n  );\n  const data = get(\n    ambassadorHTTPError,\n    'response.details.applicationError.data',\n    {},\n  );\n  const combinedMessage =\n    message === description ? message : `${message}: ${description}`;\n  const details = {\n    applicationError: {\n      description,\n      code,\n      data,\n    },\n  };\n\n  return buildError({\n    message: toYamlString({ message: combinedMessage, details }),\n    extraProperties: { details, metadata },\n  });\n};\n\nconst buildSystemError = (ambassadorHTTPError) => {\n  const code = constantCase(\n    ambassadorSafeStatusText(ambassadorHTTPError.httpStatus),\n  );\n  const message = ambassadorHTTPError.requestId\n    ? `System error occurred, request-id: ${ambassadorHTTPError.requestId}`\n    : 'System error occurred';\n\n  const metadata = buildErrorMetadata(\n    ErrorType.System,\n    ambassadorHTTPError.httpStatus,\n  );\n\n  return buildError({\n    message,\n    extraProperties: {\n      requestId: ambassadorHTTPError.requestId,\n      code,\n      metadata,\n      ...(ambassadorHTTPError.runtimeError && {\n        runtimeError: ambassadorHTTPError.runtimeError,\n      }),\n    },\n  });\n};\n\n// See https://github.com/wix-private/ambassador/blob/master/src/runtime/http.ts#L10\nconst transformError = (\n  ambassadorHTTPError,\n  transformation: any = undefined,\n  argumentNames: any = undefined,\n) => {\n  switch (true) {\n    case isValidationError(ambassadorHTTPError):\n      return buildValidationError(\n        ambassadorHTTPError,\n        transformation,\n        argumentNames,\n      );\n    case isApplicationError(ambassadorHTTPError):\n      return buildApplicationError(ambassadorHTTPError);\n    default:\n      return buildSystemError(ambassadorHTTPError);\n  }\n};\nexport { transformError };\n"],"mappings":"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","ignoreList":[]}