{"version":3,"names":["_deepForEach","_interopRequireDefault","require","_lodash","_helpers","_common","_constants","_customFunctions","ARRAY_ITEMS_PATH_PROPERTY_NAME","ARRAY_ITEM_TRANSFORMATION_PROPERTY_NAME","OMIT_SOURCE_PROPERTY_NAME","FIELDS_TO_OMIT_PROPERTY_NAME","CONSTANT_VALUE_PROPERTY_NAME","transformations","TOP_LEVEL_SIMPLE_TRANSFORMATION","TOP_LEVEL_CUSTOM_FUNCTION","TOP_LEVEL_SPREAD","NESTED_SPREAD","NESTED_UNSUPPORTED_TRANSFORMATION","TOP_LEVEL_UNSUPPORTED_TRANSFORMATION","CUSTOM_FUNCTION","NESTED_SIMPLE_TRANSFORMATION","MAP_ARRAY_ITEMS","TOP_LEVEL_MAP_ARRAY_ITEMS","TOP_LEVEL_OMIT_TRANSFORMATION","NESTED_OMIT_TRANSFORMATION","NESTED_CONSTANT_VALUE","visitorTypes","safeResolveDefaultExport","module","isEsModule","__esModule","default","deepForEach","deepForEachModule","withoutSpreadOperatorKeys","obj","Object","keys","filter","k","isSpreadOperator","safeInvokeVisitor","visitors","name","args","visitor","get","reduceComplexTransformation","transformation","accumulator","terminalPaths","addTerminals","path","leaves","length","forEach","leaf","push","join","value","key","_","some","tp","startsWith","spreadOperatorParentPath","replace","values","isArray","item","siblingKeys","isOmitTransformation","sourceExpression","fieldsToOmit","parseOmitTransformation","isMapArrayItemsTransformation","sourceArrayExpression","itemTransformation","parseMapArrayItemsTransformation","isFunctionCallExpression","functionName","argumentExpressions","parseCustomFunctionCall","isConstantExpression","isString","isJsonPathExpression","reduceTransformation","isSimpleTransformation","exports"],"sources":["../../../../src/lib/transformations/reduceTransformation.ts"],"sourcesContent":["import deepForEachModule from 'deep-for-each';\nimport { get, isArray, isString, some } from 'lodash';\n\nimport {\n  isConstantExpression,\n  isJsonPathExpression,\n  isMapArrayItemsTransformation,\n  isOmitTransformation,\n  isSimpleTransformation,\n  isSpreadOperator,\n  parseMapArrayItemsTransformation,\n  parseOmitTransformation,\n} from '../helpers';\nimport { transformations } from './common';\nimport { visitorTypes } from './constants';\nimport {\n  isFunctionCallExpression,\n  parseCustomFunctionCall,\n} from './custom-functions';\n\nconst {\n  ARRAY_ITEMS_PATH_PROPERTY_NAME,\n  ARRAY_ITEM_TRANSFORMATION_PROPERTY_NAME,\n  OMIT_SOURCE_PROPERTY_NAME,\n  FIELDS_TO_OMIT_PROPERTY_NAME,\n  CONSTANT_VALUE_PROPERTY_NAME,\n} = transformations;\n\nconst {\n  TOP_LEVEL_SIMPLE_TRANSFORMATION,\n  TOP_LEVEL_CUSTOM_FUNCTION,\n  TOP_LEVEL_SPREAD,\n  NESTED_SPREAD,\n  NESTED_UNSUPPORTED_TRANSFORMATION,\n  TOP_LEVEL_UNSUPPORTED_TRANSFORMATION,\n  CUSTOM_FUNCTION,\n  NESTED_SIMPLE_TRANSFORMATION,\n  MAP_ARRAY_ITEMS,\n  TOP_LEVEL_MAP_ARRAY_ITEMS,\n  TOP_LEVEL_OMIT_TRANSFORMATION,\n  NESTED_OMIT_TRANSFORMATION,\n  NESTED_CONSTANT_VALUE,\n} = visitorTypes;\n\nconst safeResolveDefaultExport = (module) => {\n  const isEsModule = module && module.__esModule && module.default;\n\n  return isEsModule ? module.default : module;\n};\n\nconst deepForEach = safeResolveDefaultExport(deepForEachModule);\n\nconst withoutSpreadOperatorKeys = (obj) =>\n  Object.keys(obj).filter((k) => !isSpreadOperator(k));\n\nconst safeInvokeVisitor = (visitors, name, ...args) => {\n  const visitor = get(visitors, name);\n\n  return visitor && visitor(...args);\n};\n\nconst reduceComplexTransformation = (\n  transformation,\n  { visitors, accumulator },\n) => {\n  const terminalPaths: any[] = [];\n  const addTerminals = (path, leaves: any[] = []) =>\n    leaves.length > 0\n      ? leaves.forEach((leaf) => terminalPaths.push([path, leaf].join('.')))\n      : terminalPaths.push(path);\n\n  deepForEach(transformation, (value, key, _, path) => {\n    if (some(terminalPaths, (tp) => path.startsWith(tp))) {\n      return;\n    }\n\n    if (isSpreadOperator(key)) {\n      addTerminals(path);\n\n      const spreadOperatorParentPath = path.replace(/\\.?\\*/, '');\n\n      const values = !isArray(value) ? [value] : value;\n\n      values.forEach((item) => {\n        if (spreadOperatorParentPath === '') {\n          const siblingKeys = withoutSpreadOperatorKeys(transformation);\n          safeInvokeVisitor(\n            visitors,\n            TOP_LEVEL_SPREAD,\n            accumulator,\n            item,\n            siblingKeys,\n          );\n        } else {\n          const siblingKeys = withoutSpreadOperatorKeys(\n            get(transformation, spreadOperatorParentPath),\n          );\n          safeInvokeVisitor(\n            visitors,\n            NESTED_SPREAD,\n            accumulator,\n            spreadOperatorParentPath,\n            item,\n            siblingKeys,\n          );\n        }\n      });\n\n      return;\n    }\n\n    if (isOmitTransformation(value)) {\n      addTerminals(path, [\n        OMIT_SOURCE_PROPERTY_NAME,\n        FIELDS_TO_OMIT_PROPERTY_NAME,\n      ]);\n      const { sourceExpression, fieldsToOmit } = parseOmitTransformation(value);\n\n      safeInvokeVisitor(\n        visitors,\n        NESTED_OMIT_TRANSFORMATION,\n        accumulator,\n        path,\n        sourceExpression,\n        fieldsToOmit,\n      );\n\n      return;\n    }\n\n    if (isMapArrayItemsTransformation(value)) {\n      addTerminals(path, [\n        ARRAY_ITEMS_PATH_PROPERTY_NAME,\n        ARRAY_ITEM_TRANSFORMATION_PROPERTY_NAME,\n      ]);\n\n      const { sourceArrayExpression, itemTransformation } =\n        parseMapArrayItemsTransformation(value);\n\n      safeInvokeVisitor(\n        visitors,\n        MAP_ARRAY_ITEMS,\n        accumulator,\n        path,\n        sourceArrayExpression,\n        itemTransformation,\n      );\n\n      return;\n    }\n\n    if (isFunctionCallExpression(value)) {\n      const { functionName, argumentExpressions } =\n        parseCustomFunctionCall(value);\n\n      safeInvokeVisitor(\n        visitors,\n        CUSTOM_FUNCTION,\n        accumulator,\n        path,\n        functionName,\n        argumentExpressions,\n        value,\n      );\n\n      return;\n    }\n\n    if (isConstantExpression(value)) {\n      addTerminals(path, [CONSTANT_VALUE_PROPERTY_NAME]);\n\n      safeInvokeVisitor(visitors, NESTED_CONSTANT_VALUE, {\n        accumulator,\n        path,\n        value: value[CONSTANT_VALUE_PROPERTY_NAME],\n      });\n\n      return;\n    }\n\n    if (isString(value)) {\n      if (isJsonPathExpression(value)) {\n        safeInvokeVisitor(\n          visitors,\n          NESTED_SIMPLE_TRANSFORMATION,\n          accumulator,\n          path,\n          value,\n        );\n      } else {\n        safeInvokeVisitor(\n          visitors,\n          NESTED_UNSUPPORTED_TRANSFORMATION,\n          accumulator,\n          path,\n          value,\n        );\n      }\n    }\n  });\n\n  return accumulator;\n};\n\nconst reduceTransformation = (\n  transformation,\n  { visitors, accumulator }: { visitors: any; accumulator?: any },\n) => {\n  if (isSimpleTransformation(transformation)) {\n    switch (true) {\n      case isJsonPathExpression(transformation):\n        return safeInvokeVisitor(\n          visitors,\n          TOP_LEVEL_SIMPLE_TRANSFORMATION,\n          transformation,\n        );\n\n      case isFunctionCallExpression(transformation): {\n        const { functionName, argumentExpressions } =\n          parseCustomFunctionCall(transformation);\n\n        return safeInvokeVisitor(\n          visitors,\n          TOP_LEVEL_CUSTOM_FUNCTION,\n          functionName,\n          argumentExpressions,\n          transformation,\n        );\n      }\n\n      default:\n        return safeInvokeVisitor(\n          visitors,\n          TOP_LEVEL_UNSUPPORTED_TRANSFORMATION,\n          transformation,\n        );\n    }\n  }\n\n  if (isOmitTransformation(transformation)) {\n    const { sourceExpression, fieldsToOmit } =\n      parseOmitTransformation(transformation);\n\n    return safeInvokeVisitor(\n      visitors,\n      TOP_LEVEL_OMIT_TRANSFORMATION,\n      sourceExpression,\n      fieldsToOmit,\n    );\n  }\n\n  if (isMapArrayItemsTransformation(transformation)) {\n    const { sourceArrayExpression, itemTransformation } =\n      parseMapArrayItemsTransformation(transformation);\n\n    return safeInvokeVisitor(\n      visitors,\n      TOP_LEVEL_MAP_ARRAY_ITEMS,\n      sourceArrayExpression,\n      itemTransformation,\n    );\n  }\n\n  return reduceComplexTransformation(transformation, { visitors, accumulator });\n};\n\nexport { reduceTransformation };\n"],"mappings":"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","ignoreList":[]}