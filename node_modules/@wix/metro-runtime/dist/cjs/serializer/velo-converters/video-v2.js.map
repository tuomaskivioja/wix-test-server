{"version":3,"names":["_querystring","_interopRequireDefault","require","_domain","_convertersUtils","WIX_VIDEO","videoV2","exports","types","ConverterType","FROM_JSON","transform","val","_val$posters","fileName","filename","encodeText","posterData","posters","length","poster1","poster2","poster","posterId","id","url","idx","lastIndexOf","substring","URL_HASH_PREFIX","width","height","TO_JSON","alignedVideo","alignIfLegacy","protocol","hash","pathname","URL","posterHeight","posterWidth","posterUri","querystring","parse","replace","split","WIX_PROTOCOL","res","decodeText","toString","Number"],"sources":["../../../../src/serializer/velo-converters/video-v2.ts"],"sourcesContent":["import querystring from 'querystring';\nimport type com from '../../proto';\nimport { ConverterSet, ConverterType } from '../domain';\nimport {\n  alignIfLegacy,\n  decodeText,\n  encodeText,\n  URL_HASH_PREFIX,\n  WIX_PROTOCOL,\n} from './converters-utils';\n\nconst WIX_VIDEO = 'video';\n\nexport const videoV2: ConverterSet = {\n  types: ['wix.common.VideoV2'],\n\n  [ConverterType.FROM_JSON]: {\n    transform: (val: com.wix.common.VideoV2) => {\n      if (!val) {\n        return;\n      }\n\n      let fileName = '';\n\n      if (val?.filename) {\n        fileName = `/${encodeText(val.filename)}`;\n      }\n\n      let posterData = '';\n      if (val.posters?.length) {\n        const [poster1, poster2] = val.posters;\n        const poster = poster2 || poster1;\n\n        let posterId: string = poster.id || '';\n        if (!posterId && poster.url) {\n          const idx = poster.url.lastIndexOf('/');\n          if (idx !== -1) {\n            posterId = poster.url.substring(idx + 1);\n          }\n        }\n\n        if (posterId) {\n          posterData = `${URL_HASH_PREFIX}posterUri=${posterId}&posterWidth=${\n            poster!.width\n          }&posterHeight=${poster!.height}`;\n        }\n      }\n\n      return val.id\n        ? `wix:video://v1/${val.id}${fileName}${posterData}`\n        : val.url;\n    },\n  },\n\n  [ConverterType.TO_JSON]: {\n    transform: (val: string): com.wix.common.VideoV2 | undefined => {\n      if (!val) {\n        return;\n      }\n\n      const alignedVideo = alignIfLegacy(val, WIX_VIDEO);\n\n      const { protocol, hash, pathname } = new URL(alignedVideo);\n      const {\n        posterHeight: height,\n        posterWidth: width,\n        posterUri,\n      } = querystring.parse(hash.replace(URL_HASH_PREFIX, ''));\n      const [id, fileName] = pathname\n        .replace(`${WIX_VIDEO}://v1/`, '')\n        .split('/');\n\n      if (protocol === WIX_PROTOCOL) {\n        let res: com.wix.common.VideoV2 = { id };\n\n        if (fileName) {\n          res = { ...res, filename: decodeText(fileName) };\n        }\n\n        if (!posterUri) {\n          return res;\n        }\n\n        return {\n          ...res,\n          posters: [\n            {\n              id: posterUri.toString(),\n              height: Number(height),\n              width: Number(width),\n            },\n          ],\n        };\n      }\n      return { url: val };\n    },\n  },\n};\n"],"mappings":"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","ignoreList":[]}